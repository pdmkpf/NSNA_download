$(document).ready(function(){function i(){var a=[];return $(".provider_list_item_checkbox").each(function(){$(this).prop("checked")&&a.push($(this).val())}),a}function l(){return i().join()}function v(){u.size([$("#graph").width(),$("#graph").height()]);var a=D();u.charge(.2*-a),u.linkDistance(function(){return.1*a})}function C(){d3.event&&(B=d3.event),z=B.translate,A=B.scale;var a=Math.min(1,1/A);w.selectAll(".link").style("stroke-width",function(){return a}),w.selectAll(".node_circle").style("stroke-width",function(){return a}).attr("transform","scale("+a+")"),w.selectAll(".node_name").attr("transform","scale("+a+")");var b=D()/48;w.selectAll(".node_name").attr("transform","translate( 0,"+b/2*a+")"+" scale("+a+")"),y.attr("transform","translate("+z+")"+" scale("+A+")")}function D(){return Math.min($("#graph").width(),$("#graph").height())}function E(){return $(window).width()-d-114-15-16}function G(){d3.selectAll("#no_data").remove(),d3.select("#graph").insert("div").attr("class","message").attr("id","no_data").style("visibility","visible").style("display","table").style("text-align","center").append("text").text("\uac80\uc0c9\uc5b4\ub97c \uc785\ub825\ud574\uc8fc\uc138\uc694.").style("display","table-cell").style("vertical-align","middle").style("color","#fff"),W()}function H(a,b){return moment(a,"YYYYMMDD").add("days",b).format("YYYYMMDD")}function J(a){return moment(a,"YYYY/MM/DD").format("YYYYMMDD")}function K(a){return moment(a,"YYYYMMDD").format("YYYY/MM/DD")}function L(){return document.URL+"/data.php?keyword="+encodeURIComponent(f)+"&begin="+m[0].toString()+"&end="+m[1].toString()+"&providers="+l()}function M(){$("#graph_and_timeline").width($(window).width()-d),$("#timeline_slider_container").width(E()),$("#graph").height($(window).height()-e-c),$("#graph").width($("#graph_and_timeline").width()),w.attr("width",$("#graph").width()),w.attr("height",$("#graph").height()),v(),X(),u.start()}function N(a){var b=[],c=[];jQuery.each(a.nodes,function(a,c){var d=jQuery.grep(q,function(a){return a.id===c.id});if(d.length){var e=q.map(function(a){return a.id}).indexOf(c.id);q[e].category=c.category,q[e].degree=c.degree,q[e].subcategory=c.subcategory,q[e].article=c.article}else q.push(c);b.push(c.id)}),jQuery.each(q,function(a,d){-1===b.indexOf(d.id)&&c.push(d.index)});var d=0;jQuery.each(c,function(a,b){q.splice(b+d,1),--d});var e={};jQuery.each(q,function(a,b){e[b.id]=b,b.degree<s&&(s=b.degree),b.degree>t&&(t=b.degree)}),r=[],jQuery.each(a.edges,function(a,b){r.push({source:e[b.source],target:e[b.target]})}),u.nodes(q),u.links(r)}function O(){var a=y.selectAll(".link").data(u.links(),function(a){return a.source.id+"-"+a.target.id});a.enter().insert("line").attr("class","link"),a.exit().remove()}


function P(a){
		F.select("#container").remove();
		F.select("#info-panel-header-line").style("background-color",node_color[a.subcategory]);
		var C = F.append("div").attr("id","container");
		var b = C.append("div").attr("class","provider");
		C.append("div").attr("class","name").text(a.name);
	//F.selectAll("div").remove(),F.append("div").attr("class","name_id").text(a.name).style("font-size","16px");
					//var b=F.append("div").attr("class","provider").style("font-size","12px").style("margin-top","6px");
					b.append("span").text(a.article.provider),b.append("span").text(" ("+a.article.date+")");
					var c=a.article.content.split(/"|\u201c|\u201d/);
					//var d=F.append("div").attr("class","quote").style("font-size","12px").style("margin-top","6px");
		var d = C.append("div").attr("class","quote");
					if(c.length>0){
						d.append("span").text(c[0]);
						for(var e=1;e<c.length;++e)0===e%2?d.append("span").text(c[e]):d.append("span").text('"'+c[e]+'"').style("font-weight","bold").style("background-color","rgba(255,255,0,0.5)")}else d.text("[parse_error] "+x);return F.style("display","inline")}function Q(){return F.style("top",event.pageY+10+"px").style("left",event.pageX+10+"px")}function R(){return F.style("display","none")}function S(){return F.style("display","none")}function T(a){return(a-s)/(t-s)}function U(){d3.selectAll(".node").remove();
					
					
					
					var a=y.selectAll(".node").data(u.nodes(),function(a){return a.id});
					
					
					a.enter().append("g").attr("class","node").on("mouseover",P).on("mousedown",R).on("mousemove",Q).on("mouseout",S);var b=D();
					a.append("circle").attr("class","node_circle").attr("r",function(a){
																											return T(a.degree)*b/32+b/128
																										}).style("fill",function(a){
return /*"#ccc"*/ node_color[a.subcategory];
});
var c=b/48;
a.append("text").attr("class","node_name")
.style("font-size",/*function(a){return +"px"}*/ function(a){
var fontSize = T(a.degree)*c;
if(fontSize < 9){
	//fontSize = 9;
}
return fontSize+"px";
}).attr("text-anchor","middle").attr("transform",function(){var b=c/2;return"translate(0,"+b+")"}).text(function(a){return a.name}),a.exit().transition().duration(1e3).style("opacity","0").remove()}function V(){d3.selectAll("#no_data").remove(),$("body").css({cursor:"wait"}),$("#loading").show()}function W(){$("body").css({cursor:"default"}),$("#loading").hide()}function X(){O(),U(),B&&C(),u.start()}function Y(){return d3.selectAll("#no_data").remove(),""==f?(G(),void 0):(s=1e3,t=0,$("#search_keyword_value").text(f),$("#search_date_value").text(moment(m[0],"YYYYMMDD").format("YYYY/MM/DD")+" ~ "+moment(m[1],"YYYYMMDD").format("YYYY/MM/DD")),$("#date_picker_begin").val(K(m[0])),$("#date_picker_end").val(K(m[1])),V(),d3.json(L(),function(a,b){return b?(N(b),$("#provider_count_value").text(b.misc.provider_count),$("#total_node_count_value").text("(\uc804\uccb4: "+b.misc.total_node_count+")"),$("#node_count_value").text(b.misc.branched_node_count),$("#article_count_value").text(b.misc.article_count),X(),W(),"prev"==h?setTimeout(function(){cb(),Y()},3e3):"next"==h&&setTimeout(function(){db(),Y()},3e3),void 0):(G(),void 0)}),void 0)}function bb(){w.selectAll(".node").attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).attr("transform",function(a){return"translate("+[a.x,a.y]+")"}),w.selectAll(".link").attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y})}function cb(){m[0]=H(m[0],-(j[k]+1)),m[0]<n[0]&&(m[0]=n[0]),m[0]>n[1]&&(m[0]=n[1]),m[1]=H(m[0],j[k]),m[1]<n[0]&&(m[1]=n[0]),m[1]>n[1]&&(m[1]=n[1])}function db(){m[0]=H(m[0],j[k]+1),m[0]<n[0]&&(m[0]=n[0]),m[0]>n[1]&&(m[0]=n[1]),m[1]=H(m[0],j[k]),m[1]<n[0]&&(m[1]=n[0]),m[1]>n[1]&&(m[1]=n[1])}


var z,A,B,a=800,b=800,c=60,d=340,e=0,f="",g=["\uac15\uc6d0\ub3c4\ubbfc\uc77c\ubcf4","\uac15\uc6d0\uc77c\ubcf4","\uacbd\uae30\uc77c\ubcf4","\uacbd\ub0a8\ub3c4\ubbfc\uc77c\ubcf4","\uacbd\ub0a8\uc2e0\ubb38","\uacbd\uc0c1\uc77c\ubcf4","\uacbd\uc778\uc77c\ubcf4","\uacbd\ud5a5\uc2e0\ubb38","\uad11\uc8fc\uc77c\ubcf4","\uad6d\ubbfc\uc77c\ubcf4","\uad6d\uc81c\uc2e0\ubb38","\uae30\uc790\ud611\ud68c\ubcf4","\uae40\ud3ec\ub274\uc2a4","\ub0b4\uc77c\uc2e0\ubb38","\ub2f9\uc9c4\uc2dc\ub300","\ub300\ub355\ub137","\ub300\uc804\uc77c\ubcf4","\ub9e4\uc77c\uc2e0\ubb38","\ubb34\ub4f1\uc77c\ubcf4","\ubbf8\ub514\uc5b4\uc624\ub298","\ubb38\ud654\uc77c\ubcf4","\ubd80\uc0b0\uc77c\ubcf4","\ube0c\ub808\uc774\ud06c\ub274\uc2a4","\uc0c8\uc804\ubd81\uc2e0\ubb38","\uc11c\uc6b8\uc2e0\ubb38","\uc138\uacc4\uc77c\ubcf4","\ud55c\uad6d\uacbd\uc81c","\ud55c\uad6d\uc7ac\uacbd\uc2e0\ubb38","\uc2dc\uc0ac\uc778","MBC","KNN","\uba38\ub2c8\ud22c\ub370\uc774","\uc624\ub9c8\uc774\ub274\uc2a4","\ud5e4\ub7f4\ub4dc\uacbd\uc81c","\uc2a4\ud3ec\uce20\uc11c\uc6b8","\uc2a4\ud3ec\uce20\uce78","\uc601\ub0a8\uc77c\ubcf4","\uc625\ucc9c\uc2e0\ubb38","\uc774\ub370\uc77c\ub9ac","\uc778\ucc9c\uc77c\ubcf4","\uc804\ub0a8\uc77c\ubcf4","\uc804\ubd81\ub3c4\ubbfc\uc77c\ubcf4","\uc804\ubd81\uc77c\ubcf4","\uc81c\ubbfc\uc77c\ubcf4","\uc911\ub3c4\uc77c\ubcf4","\uc911\ubd80\ub9e4\uc77c","\ucda9\ubd81\uc77c\ubcf4","\ucda9\uccad\ud22c\ub370\uc774","\ud30c\uc774\ub0b8\uc15c\ub274\uc2a4","\ud3c9\ud0dd\ubb38\ud654\uc2e0\ubb38","\ud55c\uaca8\ub808","\ud55c\ub77c\uc77c\ubcf4","\ud64d\uc131\uc2e0\ubb38","PD\uc800\ub110","\uc544\uc2dc\uc544\ud22c\ub370\uc774","\ud55c\uad6d\uc77c\ubcf4","\ub9e4\uc77c\uacbd\uc81c","\uc11c\uc6b8\uacbd\uc81c","\uc774\ud22c\ub370\uc774","\ud504\ub77c\uc784\uacbd\uc81c","\ud22c\ub370\uc774\ucf54\ub9ac\uc544","\uad6d\ubc29\uc77c\ubcf4","KBS","SBS","\ub3d9\uc544\uc77c\ubcf4","\ub178\ucef7\ub274\uc2a4","\uc870\uc138\uc77c\ubcf4","\ucf54\ub9ac\uc544\ud5e4\ub7f4\ub4dc"],h=!1,j={one_day:0,one_week:6,one_month:27,two_weeks:13},k="two_weeks",m=[20140101,H(20140101,j[k])],n=[19900101,moment().format("YYYYMMDD")],q=[],r=[],s=1e3,t=0,u=d3.layout.force().nodes(q).links(r).on("tick",bb).size([a,b]).charge(-200).linkDistance(function(a){var c=T(a.source.degree)+T(a.target.degree);return 20*c+60}),w=d3.select("#graph").append("svg").attr("width",$("#graph").width()).attr("height",$("#graph").height()).call(d3.behavior.zoom().on("zoom",C)),y=w.append("svg:g");

var F=d3.select("#info-panel");
$(window).on("resize",M),$("#date_picker_begin").val(K(m[0])),$("#date_picker_end").val(K(m[1])),$("#date_picker_begin").datepicker({showButtonPanel:!0,changeMonth:!0,changeYear:!0,dateFormat:"yy/mm/dd",minDate:K(n[0]),maxDate:K(n[1]),onClose:function(){m[0]=J($("#date_picker_begin").val()),m[1]=m[1],$("#date_picker_end").val(K(m[1])),Y()}}),$("#date_picker_end").datepicker({showButtonPanel:!0,changeMonth:!0,changeYear:!0,dateFormat:"yy/mm/dd",minDate:K(n[0]),maxDate:K(n[1]),onClose:function(){m[1]=J($("#date_picker_end").val()),m[0]=m[0],$("#date_picker_begin").val(K(m[0])),Y()}}),$("#download_date_picker_begin").datepicker({showButtonPanel:!0,changeMonth:!0,changeYear:!0,dateFormat:"yy/mm/dd",minDate:K(n[0]),maxDate:K(n[1])}),$("#download_date_picker_begin").val(K(m[0])),$("#download_date_picker_end").datepicker({showButtonPanel:!0,changeMonth:!0,changeYear:!0,dateFormat:"yy/mm/dd",minDate:K(n[0]),maxDate:K(n[1])}),$("#download_date_picker_end").val(K(m[1])),$("#excel_file_1").click(function(){var a=J($("#date_picker_begin").val()),b=J($("#date_picker_end").val());return""==f?(G(),void 0):(window.open("excel/xls_proxy_third.php?keyword="+encodeURIComponent(f.replace(/\s+/g,"+"))+"&begin="+a+"&end="+b+"&gubun="+1+"&providers="+encodeURIComponent(i().join("+")),"popupWindow","width=600,height=600,scrollbars=yes"),!1)}),$("#excel_file_3").click(function(){var a=J($("#date_picker_begin").val()),b=J($("#date_picker_end").val()),c=$("#period_select").val();return""==f?(G(),void 0):(window.open("excel/xls_proxy_second.php?keyword="+encodeURIComponent(f.replace(/\s+/g,"+"))+"&begin="+a+"&end="+b+"&period="+c+"&gubun="+3+"&providers="+encodeURIComponent(i().join("+")),"popupWindow","width=600,height=600,scrollbars=yes"),!1)}),$("#excel_file_2").click(function(){var a=J($("#date_picker_begin").val()),b=J($("#date_picker_end").val());return""==f?(G(),void 0):(window.open("excel/xls_proxy.php?keyword="+encodeURIComponent(f.replace(/\s+/g,"+"))+"&begin="+a+"&end="+b+"&gubun="+2+"&providers="+encodeURIComponent(i().join("+")),"popupWindow","width=600,height=600,scrollbars=yes"),!1)}),$(".download_date_range_button").click(function(){$(".download_date_range_button").removeClass("selected"),$(this).addClass("selected")}),$("#q_keyword").keyup(function(a){f=$("#q_keyword").val(),13==a.keyCode&&$("#search_icon").click()}),$("#search_icon").click(function(){f=$("#q_keyword").val(),Y()}),$(".date_range_button").click(function(){$(".date_range_button").removeClass("selected"),$(this).addClass("selected");var a=moment(m[0],"YYYYMMDD");if($(this).hasClass("one_day"))k="one_day",m[1]=m[0];else if($(this).hasClass("one_week")){k="one_week";var b=moment(a).add("days",j.one_week);m[1]=b.format("YYYYMMDD")}else if($(this).hasClass("one_month")){k="one_month";var b=moment(a).add("days",j.one_month);m[1]=b.format("YYYYMMDD")}else if($(this).hasClass("two_weeks")){k="two_weeks";var b=moment(a).add("days",j.two_weeks);m[1]=b.format("YYYYMMDD")}Y()}),$("#q_update").click(function(){f=$("#q_keyword").val(),m[0]=$("#q_date_begin").val(),m[1]=$("#q_date_end").val(),Y()}),$("#prev_date_range_one").click(function(){cb(),Y()}),$("#next_date_range_one").click(function(){db(),Y()}),$("#prev_date_range_auto").click(function(){$("#prev_date_range_auto").toggleClass("selected"),h?h=null:(h="prev",cb(),Y())}),

$("#next_date_range_auto").click(function(){
	$("#next_date_range_auto").toggleClass("selected"),
	h?h=null:(h="next",db(),Y())
	})
	,jQuery.each(g,function(a,b){$("#provider_list").append('<li class="provider_list_item"><input class="provider_list_item_checkbox" type="checkbox" value="'+b+'">'+b+"</li>")}),$("#provider_select_all_checkbox").click(function(){$(".provider_list_item_checkbox").each(function(){$(this).prop("checked",$("#provider_select_all_checkbox").prop("checked"))}),Y()}),$(".provider_list_item_checkbox").click(function(){Y()}),$(".provider_list_item_checkbox").each(function(){$(this).prop("checked",!0)}),$("#provider_select_all_checkbox").prop("checked",!0),$("#select_provider_text_input").keyup(function(a){var b=$("#select_provider_text_input").val();$(".provider_list_item").each(function(){-1!=new String($(this).text()).indexOf(b)?$(this).show():$(this).hide()}),27==a.keyCode&&$("#select_provider_text_input").val("")}),M()});
